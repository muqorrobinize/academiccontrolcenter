<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Control Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5; --secondary-color: #7c3aed; --accent-color: #a78bfa;
            
            /* Dark Mode Colors (Default) */
            --text-color: #e5e7eb;
            --text-color-muted: #9ca3af;
            --bg-color: #111827;
            --card-bg-color: #1f2937;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        .light-mode {
            /* Light Mode Colors */
            --text-color: #1f2937;
            --text-color-muted: #4b5563;
            --bg-color: #f3f4f6;
            --card-bg-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .card { 
            background-color: var(--card-bg-color); 
            border: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); }
        .btn-secondary { background-color: #374151; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .light-mode .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .light-mode .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .form-input, .form-select { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.5rem 0.75rem; color: white; width: 100%; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--primary-color); }
        .light-mode .form-input, .light-mode .form-select { background-color: #e5e7eb; color: #1f2937; border-color: #d1d5db;}
        .mission-card { border-left: 4px solid var(--primary-color); }
        .mission-card.overdue { border-left-color: #f87171; }
        .rank-badge { background-color: var(--primary-color); color: white; padding: 0.25rem 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 9999px; }
        .profile-pic { object-fit: cover; }
        .status-btn { border: 1px solid #4b5563; padding: 4px 8px; font-size: 12px; border-radius: 6px; transition: all 0.2s; }
        .status-btn:hover { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
        .light-mode .status-btn { border-color: #d1d5db; }
        .modal { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur-sm; }
        .filter-btn { background-color: #374151; color: #d1d5db; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .filter-btn.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .light-mode .filter-btn { background-color: #e5e7eb; color: #4b5563; }
        .light-mode .filter-btn.active { background-color: var(--primary-color); color: white; }
        .tab-btn { padding: 0.5rem 1rem; color: #9ca3af; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .text-muted { color: var(--text-color-muted); }
        .border-muted { border-color: var(--border-color); }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <header class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div><h1 class="text-3xl md:text-4xl font-bold">Academic Control Center</h1></div>
            <div class="flex items-center gap-2">
                <button id="theme-toggle" class="btn btn-secondary p-2">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 12.122l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM15 17a1 1 0 10-1.414-1.414l.707-.707a1 1 0 101.414 1.414l-.707.707zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
                <button id="settingsBtn" class="btn btn-secondary">Settings</button>
                <button id="addMissionBtn" class="btn btn-primary">+ New Task</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Profile & Stats -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card rounded-lg p-6">
                    <div class="flex flex-col items-center text-center">
                        <div class="relative cursor-pointer" onclick="document.getElementById('profilePicInput').click()">
                            <img id="profilePic" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2U1ZTdlYiI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==" class="profile-pic w-32 h-32 rounded-full border-4 border-gray-600 bg-gray-700" alt="Profile Picture">
                            <input type="file" id="profilePicInput" class="hidden" accept="image/*">
                        </div>
                        <h2 id="playerName" class="text-2xl font-bold mt-4">New Student</h2>
                        <div id="playerRank" class="rank-badge mt-2">Novice</div>
                    </div>
                    <div class="mt-6 border-t border-muted pt-4 text-sm space-y-2">
                        <p><strong class="text-muted">University:</strong> <span id="playerUniversity">Digital University</span></p>
                        <p><strong class="text-muted">Major:</strong> <span id="playerDepartment">Computer Science</span></p>
                    </div>
                    <div class="mt-6 flex justify-center gap-4">
                        <button id="exportPdfBtn" class="btn btn-secondary text-sm">Export PDF</button>
                        <button id="exportIgBtn" class="btn btn-secondary text-sm">Export Story</button>
                    </div>
                </div>

                <div class="card rounded-lg p-6">
                    <h3 class="text-xl font-bold border-b border-muted pb-2 mb-4">Performance Stats</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center"><p class="text-sm text-muted">Tasks Done</p><p id="statMissions" class="text-3xl font-bold">0</p></div>
                        <div class="text-center"><p class="text-sm text-muted">Prestige Points</p><p id="statPoints" class="text-3xl font-bold">0</p></div>
                        <div class="text-center"><p class="text-sm text-muted">Average Grade</p><p id="statAvgGrade" class="text-3xl font-bold">0.0</p></div>
                        <div class="text-center"><p class="text-sm text-muted">Estimated GPA</p><p id="statGpa" class="text-3xl font-bold">0.00</p></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Task Lists -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card rounded-lg p-4"><div id="filterContainer" class="flex gap-2"><button class="filter-btn active" data-filter="overall">Overall</button><button class="filter-btn" data-filter="semester">This Semester</button><button class="filter-btn" data-filter="month">This Month</button></div></div>
                <div id="task-lists" class="space-y-6">
                    <div class="card rounded-lg p-6"><h3 class="text-xl font-bold mb-4 text-yellow-400">In Progress</h3><div id="inprogress" class="space-y-3"></div></div>
                    <div class="card rounded-lg p-6"><h3 class="text-xl font-bold mb-4 text-blue-400">To-Do</h3><div id="todo" class="space-y-3"></div></div>
                    <div class="card rounded-lg p-6"><h3 class="text-xl font-bold mb-4 text-red-400">Overdue</h3><div id="overdue" class="space-y-3"></div></div>
                    <div class="card rounded-lg p-6"><h3 class="text-xl font-bold mb-4 text-green-400">Completed</h3><div id="completed" class="space-y-3"></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-8 text-gray-500 text-sm">
        <p>Created with Canvas on Gemini</p>
        <p class="mt-1">
            Credits: 
            <a href="https://www.instagram.com/beenspace" target="_blank" class="text-gray-400 hover:text-white">@beenspace</a> | 
            <a href="https://github.com/muqorrobinize" target="_blank" class="text-gray-400 hover:text-white">@muqorrobinize</a>
        </p>
    </footer>

    <div id="modalContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal hidden"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let playerStats, missions, categories, settings, activeFilter, timeInterval;

        const RANKS = [
            { name: 'Novice', points: 0, colors: ['#6b7280', '#4b5563', '#9ca3af'] },
            { name: 'Adept', points: 100, colors: ['#4f46e5', '#6d28d9', '#a78bfa'] },
            { name: 'Scholar', points: 300, colors: ['#16a34a', '#15803d', '#4ade80'] },
            { name: 'Virtuoso', points: 700, colors: ['#0284c7', '#0369a1', '#38bdf8'] },
            { name: 'Prodigy', points: 1500, colors: ['#ca8a04', '#a16207', '#facc15'] }
        ];

        function loadAllData() {
            const data = JSON.parse(localStorage.getItem('academic_dashboard_data_v3'));
            const pic = localStorage.getItem('academic_dashboard_pic_v3');
            const loadedCategories = JSON.parse(localStorage.getItem('academic_dashboard_categories_v3'));
            const loadedSettings = JSON.parse(localStorage.getItem('academic_dashboard_settings_v3'));
            const theme = localStorage.getItem('theme');

            if (theme === 'light') {
                document.body.classList.add('light-mode');
            }
            updateThemeToggleIcon();


            if (pic) document.getElementById('profilePic').src = pic;

            playerStats = (data && data.playerStats) ? data.playerStats : { missionsCompleted: 0, prestigePoints: 0, totalGradePoints: 0, gradedMissionsCount: 0, gpa: 0.00, avgGrade: 0.0, rank: 'Novice', overdueCount: 0 };
            missions = (data && data.missions) ? data.missions : [];
            categories = loadedCategories || { courseCats: ['Mandatory', 'Elective'], semesters: ['1', '2', '3'], difficulties: ['Easy', 'Medium', 'Hard'] };
            settings = loadedSettings || { name: 'New Student', university: 'Digital University', department: 'Computer Science', currentSemester: '1' };
            activeFilter = 'overall';
            
            if (!data && missions.length === 0) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                missions.push({ id: uuidv4(), title: 'Sample Task', description: 'This is a sample task.', courseCat: 'Mandatory', semester: '1', difficulty: 'Easy', assignedDate: new Date().toISOString().split('T')[0], deadline: tomorrow.toISOString().slice(0, 16), links: ['https://example.com'], status: 'todo', grade: null });
            }
            checkOverdueTasks();
            recalculateAllStats(missions);
        }

        function saveAllData() {
            localStorage.setItem('academic_dashboard_data_v3', JSON.stringify({ playerStats, missions }));
            localStorage.setItem('academic_dashboard_categories_v3', JSON.stringify(categories));
            localStorage.setItem('academic_dashboard_settings_v3', JSON.stringify(settings));
        }

        function renderAll() {
            renderProfile();
            renderStats(playerStats);
            renderMissions();
        }
        
        function applyTheme() {
            const rankData = RANKS.find(r => r.name === playerStats.rank) || RANKS[0];
            ['--primary-color', '--secondary-color', '--accent-color'].forEach((prop, i) => 
                document.documentElement.style.setProperty(prop, rankData.colors[i])
            );
        }
        
        function renderProfile() {
            document.getElementById('playerName').textContent = settings.name;
            document.getElementById('playerUniversity').textContent = settings.university;
            document.getElementById('playerDepartment').textContent = settings.department;
        }

        function renderStats(stats) {
            document.getElementById('statMissions').textContent = stats.missionsCompleted;
            document.getElementById('statPoints').textContent = stats.prestigePoints;
            document.getElementById('statAvgGrade').textContent = stats.avgGrade.toFixed(1);
            document.getElementById('statGpa').textContent = stats.gpa.toFixed(2);
            document.getElementById('playerRank').textContent = stats.rank;
            applyTheme();
        }

        function renderMissions() {
            ['todo', 'inprogress', 'completed', 'overdue'].forEach(status => {
                const el = document.getElementById(status);
                if(el) el.innerHTML = '';
            });
            
            const filtered = getFilteredMissions(activeFilter);

            if (filtered.length === 0) {
                 ['todo', 'inprogress', 'completed', 'overdue'].forEach(status => {
                    const el = document.getElementById(status);
                    if(el) el.innerHTML = `<p class="text-center text-muted py-4">No tasks found.</p>`;
                });
            } else {
                filtered.forEach(mission => {
                    const card = createMissionCard(mission);
                    const container = document.getElementById(mission.status);
                    if (container) container.appendChild(card);
                });
            }
        }
        
        function formatTimeRemaining(deadline) {
            if (!deadline) return '';
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diff = deadlineDate - now;

            if (diff <= 0) return '<span class="text-red-400">Expired</span>';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (days > 0) return `<span class="text-green-400">${days}d ${hours}h left</span>`;
            if (hours > 0) return `<span class="text-yellow-400">${hours}h ${minutes}m left</span>`;
            return `<span class="text-orange-400">${minutes}m left</span>`;
        }
        
        function formatDaysPassed(assignedDate) {
            if (!assignedDate) return '';
            const now = new Date();
            const assigned = new Date(assignedDate);
            now.setHours(0,0,0,0);
            assigned.setHours(0,0,0,0);
            const diff = now - assigned;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days < 0) return 'Assigned in the future';
            if (days === 0) return 'Assigned today';
            if (days === 1) return 'Assigned yesterday';
            return `Assigned ${days} days ago`;
        }

        function createMissionCard(mission) {
            const card = document.createElement('div');
            card.className = `mission-card card p-4 rounded-lg ${mission.status === 'overdue' ? 'overdue' : ''}`;
            const difficultyColors = { 'Easy': 'text-green-400', 'Medium': 'text-yellow-400', 'Hard': 'text-red-400' };
            const isCompleted = mission.status === 'completed';
            
            let linksHtml = '';
            if (mission.links && mission.links.length > 0) {
                linksHtml = `
                    <div class="mt-2">
                        <strong class="text-xs text-muted">Links:</strong>
                        <ul class="list-disc list-inside text-xs pl-2">
                            ${mission.links.map((link, index) => `<li><a href="${link}" target="_blank" class="text-blue-400 hover:underline">Link ${index + 1}</a></li>`).join('')}
                        </ul>
                    </div>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div><p class="font-bold">${mission.title}</p><p class="text-xs text-muted">${mission.courseCat} - Semester ${mission.semester}</p></div>
                    <span class="text-xs font-semibold ${difficultyColors[mission.difficulty] || ''}">${mission.difficulty}</span>
                </div>
                <p class="text-sm my-2">${mission.description || 'No description.'}</p>
                <div class="text-xs text-muted mt-2 space-y-1">
                    ${mission.assignedDate ? `<div><strong>Assigned:</strong> ${new Date(mission.assignedDate).toLocaleDateString()} (${formatDaysPassed(mission.assignedDate)})</div>` : ''}
                    ${mission.deadline ? `<div><strong>Deadline:</strong> ${new Date(mission.deadline).toLocaleString()} (${formatTimeRemaining(mission.deadline)})</div>` : ''}
                </div>
                ${linksHtml}
                ${isCompleted ? `<p class="text-lg font-bold text-green-400 mt-2">Grade: ${mission.grade}</p>` : ''}
                <div class="flex gap-2 mt-4 border-t border-muted pt-3">
                    ${!isCompleted && mission.status !== 'inprogress' ? `<button class="status-btn" onclick="window.app.updateMissionStatus('${mission.id}', 'inprogress')">In Progress</button>` : ''}
                    ${!isCompleted && mission.status !== 'todo' ? `<button class="status-btn" onclick="window.app.updateMissionStatus('${mission.id}', 'todo')">To-Do</button>` : ''}
                    ${!isCompleted ? `<button class="status-btn" onclick="window.app.openGradeModal('${mission.id}')">Complete</button>` : ''}
                    ${!isCompleted ? `<button class="status-btn ml-auto" onclick="window.app.openMissionModal('${mission.id}')">Edit</button>` : ''}
                </div>`;
            return card;
        }

        function checkOverdueTasks() {
            const now = new Date();
            let changed = false;
            missions.forEach(m => {
                if (['todo', 'inprogress'].includes(m.status) && m.deadline) {
                    const deadlineDate = new Date(m.deadline);
                    if (deadlineDate < now) {
                        m.status = 'overdue';
                        changed = true;
                    }
                }
            });
            if (changed) {
                recalculateAllStats(missions);
                saveAllData();
                renderAll();
            }
        }

        function recalculateAllStats(missionList) {
            let completed = 0, points = 0, totalGrade = 0, gradedCount = 0, totalGpa = 0, overdueCount = 0;
            missionList.forEach(m => {
                if (m.status === 'overdue') overdueCount++;
                if (m.status === 'completed') {
                    completed++;
                    let taskPoints = ({ 'Easy': 10, 'Medium': 25, 'Hard': 50 }[m.difficulty] || 0);
                    if (m.grade !== null && !isNaN(m.grade)) {
                        const grade = parseFloat(m.grade);
                        if (grade > 85) taskPoints += 10;
                        totalGrade += grade;
                        totalGpa += (grade > 85 ? 4.0 : grade > 80 ? 3.7 : grade > 75 ? 3.3 : grade > 70 ? 3.0 : grade > 65 ? 2.7 : grade > 60 ? 2.3 : grade > 55 ? 2.0 : grade > 40 ? 1.0 : 0.0);
                        gradedCount++;
                    }
                    const deadline = m.deadline ? new Date(m.deadline) : null;
                    const completedOn = m.completedOn ? new Date(m.completedOn) : null;
                    if (deadline && completedOn && completedOn.getTime() <= new Date(m.deadline).getTime()) {
                        taskPoints += 15;
                    }
                    points += taskPoints;
                }
            });
            const stats = {
                missionsCompleted: completed,
                prestigePoints: points,
                gradedMissionsCount: gradedCount,
                avgGrade: gradedCount > 0 ? totalGrade / gradedCount : 0,
                gpa: gradedCount > 0 ? totalGpa / gradedCount : 0,
                rank: (RANKS.slice().reverse().find(r => points >= r.points) || RANKS[0]).name,
                overdueCount: overdueCount
            };
            if (missionList === missions) {
                playerStats = stats;
            }
            return stats;
        }
        
        function getFilteredMissions(filter) {
            const now = new Date();
            return missions.filter(m => {
                if (filter === 'overall') return true;
                if (filter === 'semester') return m.semester === settings.currentSemester;
                if (filter === 'month') {
                    const relevantDate = m.completedOn ? new Date(m.completedOn) : (m.deadline ? new Date(m.deadline) : null);
                    return relevantDate && relevantDate.getMonth() === now.getMonth() && relevantDate.getFullYear() === now.getFullYear();
                }
            });
        }

        function getMotivationalStatement(stats) {
            if (stats.missionsCompleted === 0 && stats.overdueCount === 0) {
                return "A fresh start! Every great journey begins with a single step. Plan your tasks, set your goals, and let's begin this academic adventure together. You've got this!";
            } else if (stats.avgGrade > 85 && stats.overdueCount === 0) {
                return "Outstanding performance! Your dedication and excellent results are truly impressive. Keep up the phenomenal work and continue to aim for the stars. You are on a path to great success.";
            } else if (stats.avgGrade > 70 && stats.overdueCount <= 2) {
                return "Great job! You are maintaining a solid performance and showing consistent effort. Continue this momentum, stay organized, and you will achieve your academic goals. Well done!";
            } else if (stats.overdueCount > 2 || (stats.avgGrade < 60 && stats.gradedMissionsCount > 0)) {
                return "This period had its challenges, but every challenge is an opportunity for growth. Focus on prioritizing tasks and tackling them one by one. Remember, consistency is key to improvement. You have the ability to turn things around.";
            } else {
                return "Good effort this period. Each completed task is a step forward. Continue to build on your progress and strive for consistency in your studies. Keep pushing forward!";
            }
        }

        function updateThemeToggleIcon() {
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('theme-toggle-light-icon').classList.toggle('hidden', isLight);
            document.getElementById('theme-toggle-dark-icon').classList.toggle('hidden', !isLight);
        }

        const app = {
            closeModal: () => document.getElementById('modalContainer').classList.add('hidden'),
            openModal: (content) => {
                const modalContainer = document.getElementById('modalContainer');
                modalContainer.innerHTML = content;
                modalContainer.classList.remove('hidden');
            },
            openMissionModal: (missionId = null) => {
                const mission = missionId ? missions.find(m => m.id === missionId) : null;
                const today = new Date().toISOString().split('T')[0];
                
                const linksHtml = (mission?.links || ['']).map((link, index) => `
                    <div class="flex items-center gap-2" id="link-group-${index}">
                        <input type="url" class="form-input mission-link-input" placeholder="https://..." value="${link}">
                        ${index > 0 ? `<button type="button" onclick="document.getElementById('link-group-${index}').remove()" class="text-red-400 hover:text-red-300">&times;</button>` : ''}
                    </div>
                `).join('');

                app.openModal(`
                    <div class="card rounded-lg p-6 w-full max-w-lg mx-auto">
                        <h3 class="text-xl font-bold mb-4">${mission ? 'Edit Task' : 'New Task'}</h3>
                        <form id="missionForm" class="space-y-4">
                            <input type="hidden" id="missionId" value="${mission?.id || ''}">
                            <div><label class="block text-sm">Title</label><input type="text" id="missionTitle" class="form-input" value="${mission?.title || ''}" required></div>
                            <div><label class="block text-sm">Description</label><textarea id="missionDesc" class="form-input" rows="2">${mission?.description || ''}</textarea></div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div><label class="block text-sm">Course Category</label><select id="missionCourseCat" class="form-select">${categories.courseCats.map(c => `<option ${mission?.courseCat === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
                                <div><label class="block text-sm">Semester</label><select id="missionSemester" class="form-select">${categories.semesters.map(s => `<option ${mission?.semester === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div><label class="block text-sm">Difficulty</label><select id="missionDifficulty" class="form-select">${categories.difficulties.map(d => `<option ${mission?.difficulty === d ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                                <div><label class="block text-sm">Assigned Date</label><input type="date" id="missionAssignedDate" class="form-input" value="${mission?.assignedDate || today}"></div>
                            </div>
                            <div><label class="block text-sm">Deadline (Date & Time)</label><input type="datetime-local" id="missionDeadline" class="form-input" value="${mission?.deadline || ''}"></div>
                            <div>
                                <label class="block text-sm">Links</label>
                                <div id="links-container" class="space-y-2">${linksHtml}</div>
                                <button type="button" id="add-link-btn" class="text-sm text-blue-400 hover:underline mt-2">Add another link</button>
                            </div>
                            <div class="flex justify-end gap-2 pt-4">
                                ${mission ? `<button type="button" onclick="window.app.deleteMission('${mission.id}')" class="btn btn-danger">Delete</button>` : ''}
                                <button type="button" onclick="window.app.closeModal()" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        </form>
                    </div>`);
                
                document.getElementById('add-link-btn').addEventListener('click', () => {
                    const container = document.getElementById('links-container');
                    const newIndex = container.children.length;
                    const newLinkInput = document.createElement('div');
                    newLinkInput.className = 'flex items-center gap-2';
                    newLinkInput.id = `link-group-${newIndex}`;
                    newLinkInput.innerHTML = `
                        <input type="url" class="form-input mission-link-input" placeholder="https://...">
                        <button type="button" onclick="document.getElementById('link-group-${newIndex}').remove()" class="text-red-400 hover:text-red-300 text-xl">&times;</button>
                    `;
                    container.appendChild(newLinkInput);
                });

                document.getElementById('missionForm').addEventListener('submit', app.saveMission);
            },
            saveMission: (e) => {
                e.preventDefault();
                const id = document.getElementById('missionId').value;
                const linkInputs = document.querySelectorAll('.mission-link-input');
                const links = Array.from(linkInputs).map(input => input.value.trim()).filter(link => link);

                const missionData = {
                    title: document.getElementById('missionTitle').value,
                    description: document.getElementById('missionDesc').value,
                    courseCat: document.getElementById('missionCourseCat').value,
                    semester: document.getElementById('missionSemester').value,
                    difficulty: document.getElementById('missionDifficulty').value,
                    assignedDate: document.getElementById('missionAssignedDate').value,
                    deadline: document.getElementById('missionDeadline').value,
                    links: links,
                };
                if (id) Object.assign(missions.find(m => m.id === id), missionData);
                else missions.push({ ...missionData, id: uuidv4(), status: 'todo' });
                checkOverdueTasks();
                recalculateAllStats(missions);
                saveAllData();
                renderAll();
                app.closeModal();
            },
            deleteMission: (id) => {
                if (confirm('Are you sure you want to delete this task?')) {
                    missions = missions.filter(m => m.id !== id);
                    recalculateAllStats(missions);
                    saveAllData();
                    renderAll();
                    app.closeModal();
                }
            },
            updateMissionStatus: (id, newStatus) => {
                const mission = missions.find(m => m.id === id);
                if (mission) {
                    mission.status = newStatus;
                    if (newStatus !== 'completed') mission.grade = null;
                    checkOverdueTasks();
                    recalculateAllStats(missions);
                    saveAllData();
                    renderAll();
                }
            },
            openGradeModal: (id) => {
                app.openModal(`
                    <div class="card rounded-lg p-6 w-full max-w-sm mx-auto">
                        <h3 class="text-xl font-bold mb-4">Complete Task</h3>
                        <form id="gradeForm">
                            <label class="block text-sm">Enter final grade (0-100)</label>
                            <input type="number" id="gradeInput" class="form-input mt-1" min="0" max="100" required>
                            <div class="flex justify-end gap-2 pt-4">
                                <button type="button" onclick="window.app.closeModal()" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        </form>
                    </div>`);
                document.getElementById('gradeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const grade = parseFloat(document.getElementById('gradeInput').value);
                    const mission = missions.find(m => m.id === id);
                    mission.status = 'completed';
                    mission.grade = grade;
                    mission.completedOn = new Date().toISOString();
                    recalculateAllStats(missions);
                    saveAllData();
                    renderAll();
                    app.closeModal();
                });
            },
            handleProfilePicUpload: (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        document.getElementById('profilePic').src = e.target.result;
                        localStorage.setItem('academic_dashboard_pic_v3', e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            },
            openSettingsModal: () => {
                app.openModal(`
                    <div class="card rounded-lg p-0 w-full max-w-3xl mx-auto">
                        <div class="p-6 border-b border-muted flex justify-between items-center"><h3 class="text-xl font-bold">Settings</h3><button onclick="window.app.closeModal()" class="text-muted hover:text-white text-2xl">&times;</button></div>
                        <div class="flex border-b border-muted">
                            <button class="tab-btn active" data-tab="profile">Profile</button>
                            <button class="tab-btn" data-tab="categories">Categories</button>
                            <button class="tab-btn" data-tab="data">Data</button>
                        </div>
                        <div class="p-6">
                            <div id="profileTab" class="tab-content active">
                                <h4 class="font-bold mb-2">Profile</h4>
                                <div class="grid md:grid-cols-2 gap-4 mb-4">
                                    <div><label class="block text-sm">Name</label><input id="settingName" class="form-input" value="${settings.name}"></div>
                                    <div><label class="block text-sm">University</label><input id="settingUniversity" class="form-input" value="${settings.university}"></div>
                                    <div><label class="block text-sm">Major</label><input id="settingDepartment" class="form-input" value="${settings.department}"></div>
                                    <div><label class="block text-sm">Current Semester</label><select id="settingCurrentSemester" class="form-select">${categories.semesters.map(s => `<option ${settings.currentSemester === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                                </div>
                                <button onclick="window.app.saveSettings()" class="btn btn-primary">Save Profile</button>
                            </div>
                            <div id="categoriesTab" class="tab-content"></div>
                            <div id="dataTab" class="tab-content"></div>
                        </div>
                    </div>`);
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(`${e.target.dataset.tab}Tab`).classList.add('active');
                    });
                });
                app.renderCategorySettings();
                app.renderDataSettings();
            },
            renderCategorySettings: () => {
                const container = document.getElementById('categoriesTab');
                if (!container) return;
                const renderList = (title, key) => {
                    let itemsHtml = categories[key].map(item => `
                        <li class="flex justify-between items-center bg-gray-800 p-2 rounded">
                            <span>${item}</span>
                            <button onclick="window.app.deleteCategoryItem('${key}', '${item}')" class="text-red-400 hover:text-red-300 text-xs">Delete</button>
                        </li>`).join('');
                    return `
                        <div class="mb-6">
                            <h5 class="font-semibold mb-2">${title}</h5>
                            <ul class="space-y-2 mb-2">${itemsHtml}</ul>
                            <div class="flex gap-2">
                                <input type="text" id="new${key}" class="form-input" placeholder="Add new...">
                                <button onclick="window.app.addCategoryItem('${key}')" class="btn btn-secondary">Add</button>
                            </div>
                        </div>`;
                };
                container.innerHTML = `
                    <h4 class="font-bold mb-4">Manage Categories</h4>
                    <div class="grid md:grid-cols-3 gap-6">
                        ${renderList('Course Categories', 'courseCats')}
                        ${renderList('Semesters', 'semesters')}
                        ${renderList('Difficulties', 'difficulties')}
                    </div>`;
            },
            addCategoryItem: (key) => {
                const input = document.getElementById(`new${key}`);
                const value = input.value.trim();
                if (value && !categories[key].includes(value)) {
                    categories[key].push(value);
                    saveAllData();
                    app.renderCategorySettings();
                }
                input.value = '';
            },
            deleteCategoryItem: (key, value) => {
                if (confirm(`Are you sure you want to delete "${value}"? This cannot be undone.`)) {
                    categories[key] = categories[key].filter(item => item !== value);
                    saveAllData();
                    app.renderCategorySettings();
                }
            },
            renderDataSettings: () => {
                const container = document.getElementById('dataTab');
                if (!container) return;
                container.innerHTML = `
                    <h4 class="font-bold mb-4">Data Management</h4>
                    <div class="space-y-4">
                        <div>
                            <p class="font-semibold">Clear Completed Tasks</p>
                            <p class="text-sm text-muted mb-2">This will permanently delete all tasks marked as "Completed".</p>
                            <button onclick="window.app.clearCompletedTasks()" class="btn btn-danger">Clear Data</button>
                        </div>
                        <div>
                            <p class="font-semibold">Reset All Data</p>
                            <p class="text-sm text-muted mb-2">This will delete ALL tasks, settings, and profile information. The application will be reset to its default state.</p>
                            <button onclick="window.app.resetAllData()" class="btn btn-danger">Reset Application</button>
                        </div>
                    </div>`;
            },
            clearCompletedTasks: () => {
                if (confirm('Are you sure you want to delete all completed tasks? This action cannot be undone.')) {
                    missions = missions.filter(m => m.status !== 'completed');
                    recalculateAllStats(missions);
                    saveAllData();
                    renderAll();
                    alert('Completed tasks have been cleared.');
                }
            },
            resetAllData: () => {
                if (confirm('WARNING: This will delete all your data. Are you absolutely sure you want to reset the application?')) {
                    localStorage.removeItem('academic_dashboard_data_v3');
                    localStorage.removeItem('academic_dashboard_pic_v3');
                    localStorage.removeItem('academic_dashboard_categories_v3');
                    localStorage.removeItem('academic_dashboard_settings_v3');
                    location.reload();
                }
            },
            saveSettings: () => {
                settings.name = document.getElementById('settingName').value;
                settings.university = document.getElementById('settingUniversity').value;
                settings.department = document.getElementById('settingDepartment').value;
                settings.currentSemester = document.getElementById('settingCurrentSemester').value;
                saveAllData();
                renderAll();
                app.closeModal();
                alert('Settings saved!');
            },
            exportToPdf: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const filtered = getFilteredMissions(activeFilter);
                const stats = recalculateAllStats(filtered);
                const rankColor = RANKS.find(r => r.name === stats.rank)?.colors[0] || '#374151';
                const today = new Date().toLocaleDateString('en-GB');

                doc.setFillColor(rankColor);
                doc.rect(0, 0, 210, 25, 'F');
                doc.setFontSize(22);
                doc.setTextColor('#FFFFFF');
                doc.setFont('helvetica', 'bold');
                doc.text(`Academic Report: ${activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1)}`, 105, 16, { align: 'center' });

                doc.setFontSize(12);
                doc.setTextColor(50);
                doc.setFont('helvetica', 'bold');
                doc.text(settings.name, 14, 40);
                doc.setFont('helvetica', 'normal');
                doc.text(`${settings.department}, ${settings.university}`, 14, 47);
                doc.text(`Report Generated: ${today}`, 200, 47, { align: 'right' });
                doc.setLineWidth(0.5);
                doc.line(14, 52, 196, 52);

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text("Performance Summary", 14, 62);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Rank: ${stats.rank}`, 14, 70);
                doc.text(`Tasks Completed: ${stats.missionsCompleted}`, 14, 77);
                doc.text(`Prestige Points: ${stats.prestigePoints}`, 70, 70);
                doc.text(`Average Grade: ${stats.avgGrade.toFixed(1)}`, 70, 77);
                doc.text(`Estimated GPA: ${stats.gpa.toFixed(2)}`, 130, 70);
                doc.text(`Overdue Tasks: ${stats.overdueCount}`, 130, 77);
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text("Statement & Motivation", 14, 92);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'italic');
                const statement = getMotivationalStatement(stats);
                const splitStatement = doc.splitTextToSize(statement, 182);
                doc.setTextColor(100);
                doc.text(splitStatement, 14, 99);
                doc.line(14, 95, 196, 95);

                let y = 125;
                const completedTasks = filtered.filter(m => m.status === 'completed');
                if (completedTasks.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(50);
                    doc.text("Completed Task Details", 14, y);
                    y += 8;

                    completedTasks.slice(0, 15).forEach(m => {
                        if (y > 270) { 
                            doc.addPage();
                            y = 20;
                        }
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`- ${m.title}`, 16, y);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`(Grade: ${m.grade}, Difficulty: ${m.difficulty})`, 130, y);
                        y += 6;
                    });
                }

                doc.save(`${settings.name}_report_${activeFilter}.pdf`);
            },
            exportToIgStory: () => {
                const { jsPDF } = window.jspdf;
                const filtered = getFilteredMissions(activeFilter);
                const stats = recalculateAllStats(filtered);
                const rankData = RANKS.find(r => r.name === stats.rank) || RANKS[0];
                
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [108, 192] });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const centerX = pageWidth / 2;

                doc.setFillColor(rankData.colors[0]);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');

                doc.setFontSize(10);
                doc.setTextColor('#E5E7EB');
                doc.text(`REPORT: ${activeFilter.toUpperCase()}`, centerX, 20, { align: 'center' });
                doc.setFontSize(24);
                doc.setTextColor('#FFFFFF');
                doc.setFont('helvetica', 'bold');
                doc.text(settings.name, centerX, 30, { align: 'center' });

                const imgData = document.getElementById('profilePic').src;
                if (imgData && !imgData.startsWith('data:image/svg+xml')) {
                    const imgSize = 40;
                    try {
                        doc.addImage(imgData, 'PNG', centerX - (imgSize / 2), 60, imgSize, imgSize);
                    } catch (e) {
                        console.error("Could not add image to PDF:", e);
                    }
                }
                
                doc.setFontSize(16);
                doc.setTextColor(rankData.colors[2]);
                doc.text(stats.rank, centerX, 55, { align: 'center' });

                const statsY = 120;
                const col1X = pageWidth * 0.25;
                const col2X = pageWidth * 0.75;

                doc.setFontSize(10);
                doc.setTextColor('#E5E7EB');
                doc.text('TASKS DONE', col1X, statsY, { align: 'center' });
                doc.text('POINTS', col2X, statsY, { align: 'center' });
                doc.text('AVG. GRADE', col1X, statsY + 20, { align: 'center' });
                doc.text('GPA', col2X, statsY + 20, { align: 'center' });
                
                doc.setFontSize(20);
                doc.setTextColor('#FFFFFF');
                doc.setFont('helvetica', 'bold');
                doc.text(stats.missionsCompleted.toString(), col1X, statsY + 8, { align: 'center' });
                doc.text(stats.prestigePoints.toString(), col2X, statsY + 8, { align: 'center' });
                doc.text(stats.avgGrade.toFixed(1), col1X, statsY + 28, { align: 'center' });
                doc.text(stats.gpa.toFixed(2), col2X, statsY + 28, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor('#E5E7EB');
                doc.text('Academic Control Center', centerX, pageHeight - 15, { align: 'center' });

                doc.save(`academic_story_${settings.name}_${activeFilter}.pdf`);
            },
        };
        window.app = app;

        document.getElementById('addMissionBtn').addEventListener('click', () => app.openMissionModal());
        document.getElementById('settingsBtn').addEventListener('click', app.openSettingsModal);
        document.getElementById('exportPdfBtn').addEventListener('click', app.exportToPdf);
        document.getElementById('exportIgBtn').addEventListener('click', app.exportToIgStory);
        document.getElementById('profilePicInput').addEventListener('change', app.handleProfilePicUpload);
        document.getElementById('filterContainer').addEventListener('click', (e) => {
            if (e.target.matches('.filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                activeFilter = e.target.dataset.filter;
                renderMissions();
            }
        });
        
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
            updateThemeToggleIcon();
        });

        loadAllData();
        renderAll();

        timeInterval = setInterval(() => {
            checkOverdueTasks();
            renderMissions();
        }, 60000); // Check every minute
    });
    </script>
</body>
</html>
